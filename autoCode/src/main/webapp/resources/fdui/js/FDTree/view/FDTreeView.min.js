var FDTreeView=function(a){this.options=a;this.div=document.createElement(FDTag.DIV);this.div.className="pui-tree ui-widget ui-widget-content ui-corner-all";this.uniqueIdPrefix="fdtree_"+FDControl.generateCount()+"_";this.objId="objId_"+FDControl.generateCount();FDTreeView.objs[this.objId]=this;this.nodeStore={};FDLib.getEl(a.domId).appendChild(this.div)};FDTreeView.objs={};FDTreeView.nodeStore={};FDTreeView.prototype={refresh:function(a){this.buildTree(a)},hide:function(){FDLib.dom.hideDom(this.div)},show:function(){FDLib.dom.showDom(this.div)},clickNode:function(c){var b=this._wrapId2UniqueId(c);var a=FDLib.getEl(b);if(a){this._expandParent(a);this._clickNode(a)}},select:function(b,a){this._doSelectOption(b,function(d,c){c.checked=true;if(FDLib.util.isFunction(a)){a(d,c)}})},unselect:function(b,a){this._doSelectOption(b,function(d,c){c.checked=false;if(FDLib.util.isFunction(a)){a(d,c)}})},selectAll:function(a){this._doSelectAllOption(function(c,b){b.checked=true;if(FDLib.util.isFunction(a)){a(c,b)}})},unselectAll:function(a){this._doSelectAllOption(function(c,b){b.checked=false;if(FDLib.util.isFunction(a)){a(c,b)}})},selectOthers:function(a){this._doSelectAllOption(function(c,b){b.checked=!b.checked;if(FDLib.util.isFunction(a)){a(c,b)}})},_doSelectAllOption:function(c){if(this._getOptionsValue("checkable")){var a=this;var b=this._getAllCheckboxes();FDLib.util.each(b,function(e){var d=a._getNodeObjById(e.value);c(d,e)})}},_getAllCheckboxes:function(){return FDLib.dom.getChildNodes(this.div,"input")},getSelectedCheckboxes:function(){if(!this._getOptionsValue("checkable")){return[]}var b=[];var a=this._getAllCheckboxes();FDLib.util.each(a,function(c){if(c.checked){b.push(c)}});return b},_doSelectOption:function(f,e){if(this._getOptionsValue("checkable")){var d=this._wrapId2UniqueId(f);var a=FDLib.getEl(d);if(a){this._expandParent(a);var c=FDLib.dom.getChildNodes(a,"input")[0];if(c&&f==c.value){var b=this._getNodeObjById(c.value);e(b,c)}}}},_expandParent:function(b){var a=b.getAttribute("pId");if(a){b=FDLib.getEl(a);this.expand(b,b.nextSibling);this._expandParent(b)}},toggle:function(b){if(this._hasChildNode(b)){var a=b.parentNode.nextSibling;if(!a.isExpand){this.expand(b,a)}else{this.collapse(b,a)}}},expand:function(b,a){FDLib.dom.removeClass(b,"ui-icon-triangle-1-e");FDLib.dom.addClass(b,"ui-icon-triangle-1-s");a.isExpand=true;FDLib.dom.showDom(a)},collapse:function(b,a){FDLib.dom.removeClass(b,"ui-icon-triangle-1-s");FDLib.dom.addClass(b,"ui-icon-triangle-1-e");a.isExpand=false;FDLib.dom.hideDom(a)},expandAll:function(c){var a=FDLib.dom.getChildNodes(this.div,"span");var b=this;FDLib.util.each(a,function(d){if(b._hasChildNode(d)){b.expand(d);if(FDLib.util.isFunction(c)){var e=b._getNodeObjByUniqueId(d.id);c(e)}}})},collapseAll:function(c){var a=FDLib.dom.getChildNodes(this.div,"span");var b=this;FDLib.util.each(a,function(d){if(b._hasChildNode(d)){b.collapse(d);if(FDLib.util.isFunction(c)){var e=b._getNodeObjByUniqueId(d.id);c(e)}}})},buildTree:function(d){var c=new JString();c.append('<ul class="pui-tree-container">');for(var b=0,a=d.length;b<a;b++){this.buildTreeHtml(d[b],c)}c.append("</ul>");this.div.innerHTML=c.toString()},buildTreeHtml:function(f,e){this._createId(f);var d=this._getChildren(f);this._storeNode(f);var b=d.length>0;var g="pui-treenode"+(b?" pui-treenode-parent":"");e.append('<li class="'+g+'">');if(b){e.append(this._buildNodeDisplay(f));e.append('<ul class="pui-treenode-children" style="display: none;">');for(var c=0,a=d.length;c<a;c++){d[c].parentUniqueId=this._getUniqueId(f);this.buildTreeHtml(d[c],e)}e.append("</ul>")}else{e.append(this._buildNormalNodeHtml(f))}e.append("</li>")},_createId:function(a){var b=(this._getNodeId(a)||FDControl.generateCount());this._setNodeId(a,b)},_buildToggleNodeHtml:function(b){var c=new JString();var a=b.parentUniqueId?"pId="+b.parentUniqueId:"";c.append('<span class="pui-treenode-content pui-treenode-selectable" isroot="true" '+a+">").append('<a href="javascript:void(0)">+</a>').append(this._buildNodeTextHtml(b)).append("</span>");return c.toString()},_buildNodeDisplay:function(c){var d=new JString();var e=this._buildNodeTextHtml(c);var i="FDTreeView.objs['"+this.objId+"'].toggle(this);";var f='<span onclick="'+i+'" class="pui-tree-toggler ui-icon ui-icon-triangle-1-e"></span>';var a=c.iconClassName||"ui-icon-folder-collapsed";var h='<span class="pui-treenode-icon ui-icon '+a+'"></span>';var b="FDTreeView.objs['"+this.objId+"']._clickNode(this);";var j='<span id="'+this._getUniqueId(c)+'" onclick="'+b+'" class="pui-treenode-label ui-corner-all">'+e+"</span>";var g=c.parentUniqueId?"pId="+c.parentUniqueId:"";d.append('<span class="pui-treenode-content pui-treenode-selectable" id="'+this._getUniqueId(c)+'" '+g+">").append(f).append(h).append(j).append("</span>");return d.toString()},_buildNormalNodeHtml:function(c){var d=new JString();var e=this._buildNodeTextHtml(c);var f='<span class="pui-treenode-leaf-icon"></span>';var a=c.iconClassName||"ui-icon-document";var h='<span class="pui-treenode-icon ui-icon '+a+'"></span>';var b="FDTreeView.objs['"+this.objId+"']._clickNode(this);";var i='<span id="'+this._getUniqueId(c)+'" onclick="'+b+'" class="pui-treenode-label ui-corner-all">'+e+"</span>";var g=c.parentUniqueId?"pId="+c.parentUniqueId:"";d.append('<span class="pui-treenode-content pui-treenode-selectable" id="'+this._getUniqueId(c)+'" '+g+">").append(f).append(h).append(i).append("</span>");return d.toString()},_buildNodeTextHtml:function(a){var b="";if(this._getOptionsValue("checkable")){b+=this._buildCheckboxHtml(a)}b+=this._getNodeText(a);return b},_buildEvent:function(){var a=this;FDLib.event.addBatchEvent({superDom:this.div,tagName:"SPAN",eventName:"click",handler:function(b){a._clickNode(b)}});FDLib.event.addBatchEvent({superDom:this.div,tagName:"A",eventName:"click",handler:function(b){var c=b.parentNode;a.toggle(c)}})},_buildCheckboxHtml:function(b){var c=this._getNodeId(b);var a="FDTreeView.objs['"+this.objId+"'].runCheckboxClick(event);";return'<input type="checkbox" onclick="'+a+'" value="'+c+'">'},runCheckboxClick:function(e){e=FDLib.event.formatEvent(e);var f=e.target;var d=this;var c=f.parentNode;this._runOncheckHandler(f.value,f);if(this._hasChildNode(c)){var b=c.parentNode.nextSibling;var a=FDLib.dom.getChildNodes(b,"input");FDLib.util.each(a,function(g){g.checked=f.checked;d._runOncheckHandler(g.value,g)})}e.stopPropagation()},_runOncheckHandler:function(d,c){var b=this._getNodeObjById(d);var a=this._getOptionsValue("onchecked");if(FDLib.util.isFunction(a)){a(b,c)}},_clickNode:function(a){if(this._getOptionsValue("clickToggle")){this.toggle(a)}this._setHighlight(a);this._runOnclickHandler(a.id)},_getChildren:function(a){return a[this._getOptionsValue("childrenFieldName")]||[]},_getNodeId:function(a){return a[this._getOptionsValue("valueFieldName")]},_setNodeId:function(a,b){a[this._getOptionsValue("valueFieldName")]=b},_getUniqueId:function(a){return this._wrapId2UniqueId(this._getNodeId(a))},_wrapId2UniqueId:function(a){return this.uniqueIdPrefix+a},_getNodeText:function(a){return a[this._getOptionsValue("textFieldName")]},_getOptionsValue:function(a){return this.options[a]},_hasChildNode:function(a){return !!a.parentNode.nextSibling},_runOnclickHandler:function(b){var a=this._getNodeObjByUniqueId(b);if(this.options.onclick){this.options.onclick(a)}},_setHighlight:function(a){this._removeOtherHighlight();FDLib.dom.addClass(a,"selected")},_removeOtherHighlight:function(){var b=this._getAllClickNodes();var a=FDLib.dom;FDLib.util.each(b,function(c){if(a.hasClass(c,"selected")){a.removeClass(c,"selected");return false}})},_getAllClickNodes:function(){return FDLib.dom.getChildNodes(this.div,"span")},_getNodeObjById:function(b){var a=this._wrapId2UniqueId(b);return this._getNodeObjByUniqueId(a)},_getNodeObjByUniqueId:function(a){return this.nodeStore[a]},_storeNode:function(a){var b=this._getUniqueId(a);this.nodeStore[b]=a}};